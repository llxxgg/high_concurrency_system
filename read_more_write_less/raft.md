# 共识算法 - Raft

## Leader选举

节点状态：

* leader：负责接收写请求，同步日志给follower，维护与follower的心跳，刷新follower的超时时间
* follower
* candidate：选举模式，集群中没有leader节点。

 leader宕机后，follower如果在超时时间内没有收到leader的心跳，会发起新一轮的leader投票选举。如果全部follower都在同一时间发起leader投票选举，会造成选举混乱，raft利用随机超时巧妙避开了这些问题。

收到投票申请的节点，并且发送投票的节点的任期和同步进度（即logIndex和term）都比当前节点超前或者相同，那么就会投发送投票的节点一票，并把当前的term更新为最新的term。同时，这个收到投票申请的节点不会再发起投票。每个节点在同一任期内只会投票一次。

所有服务都没有获取到多数票，就会等当前选举超时后，对term加1，再次进行选举。最终，获取多数票且最先结束选举倒计时的服务会被选为leader。

被选为leader的节点会发送广播通知其他节点，并向其他节点同步新的term和同步进度情况。同时，新leader会在任期期间周期性发送心跳，不断刷新follower的超时时间，保证各个follower不会因为超时而切换到选举模式。如果节点收到上一任期的心跳，会拒绝。

选举结束后，所有节点进入数据同步状态。

## 日志复制

Raft的日志以日志项（logEntry）的形式来组织，每个日志项包含一条命令、任期信息（term）、索引值（logIndex）

Raft复制过程：leader接收到客户端发来的请求，创建一个新的日志项，并将其追加到本地日志中，接着leader通过追加条目RPC请求，将新的日志项复制到follower的本地日志中，当leader收到大多数follower的成功响应之后，则将这条日志项应用到状态机中，可以理解为该条日志写成功了，最后leader返回日志写成功的消息响应客户端。

如何保证日志的一致性？

在raft的日志机制中，为了简化日志一致性的行为，有以下两点特性：

1. 如果在不同的日志中的两个条目拥有相同的索引和任期号，那么他们存储了相同的指令。
2. 如果在不同的日志中的两个条目拥有相同的索引和任期号，那么他们之前的所有日志条目也全部相同。

因此，raft日志追加大致分为两个步骤：

1. leader找到follower与自己相同的最大日志项，意味着follower之前的日志都与leader的日志相同。
2. leader强制覆盖之后不一致的日志。

leader是如何识别出follower的日志与自己的日志有差异呢？

leader给follower同步日志的时候，会同时带上leader上一条日志的任期和索引号，与follower当前的同步进度进行对比。
